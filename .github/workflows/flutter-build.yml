name: Flutter Build & Release

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'

    - name: Install Linux dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev

    - name: Flutter doctor
      run: flutter doctor -v

    - name: Create platform folders if needed
      working-directory: flutter-app
      run: |
        if [ ! -d "linux" ]; then
          flutter create --platforms=linux .
        fi

    - name: Get dependencies
      working-directory: flutter-app
      run: flutter pub get

    - name: Run tests
      working-directory: flutter-app
      run: flutter test || echo "No tests found"

    - name: Build Linux
      working-directory: flutter-app
      run: flutter build linux --release

    - name: Package Linux build
      run: |
        cd flutter-app/build/linux/x64/release/bundle
        tar -czvf ../../../../../similarity_quiz-linux-x64.tar.gz .

    - name: Upload Linux build
      uses: actions/upload-artifact@v4
      with:
        name: linux-build
        path: flutter-app/similarity_quiz-linux-x64.tar.gz

  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'

    - name: Flutter doctor
      run: flutter doctor -v

    - name: Create platform folders if needed
      working-directory: flutter-app
      run: |
        if (!(Test-Path "windows")) {
          flutter create --platforms=windows .
        }

    - name: Get dependencies
      working-directory: flutter-app
      run: flutter pub get

    - name: Build Windows
      working-directory: flutter-app
      run: flutter build windows --release

    - name: Package Windows build
      run: |
        Compress-Archive -Path flutter-app/build/windows/x64/runner/Release/* -DestinationPath flutter-app/similarity_quiz-windows-x64.zip

    - name: Upload Windows build
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: flutter-app/similarity_quiz-windows-x64.zip

  build-macos:
    runs-on: macos-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'

    - name: Flutter doctor
      run: flutter doctor -v

    - name: Create platform folders if needed
      working-directory: flutter-app
      run: |
        if [ ! -d "macos" ]; then
          flutter create --platforms=macos .
        fi

    - name: Get dependencies
      working-directory: flutter-app
      run: flutter pub get

    - name: Build macOS
      working-directory: flutter-app
      run: flutter build macos --release

    - name: Package macOS build
      run: |
        cd flutter-app/build/macos/Build/Products/Release
        zip -r ../../../../../similarity_quiz-macos.zip "similarity_quiz.app"

    - name: Upload macOS build
      uses: actions/upload-artifact@v4
      with:
        name: macos-build
        path: flutter-app/similarity_quiz-macos.zip

  build-android:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'

    - name: Flutter doctor
      run: flutter doctor -v

    - name: Create platform folders if needed
      working-directory: flutter-app
      run: |
        if [ ! -d "android" ]; then
          flutter create --platforms=android .
        fi

    - name: Get dependencies
      working-directory: flutter-app
      run: flutter pub get

    - name: Build APK
      working-directory: flutter-app
      run: flutter build apk --release

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: flutter-app/build/app/outputs/flutter-apk/app-release.apk

  # リリースジョブ
  release:
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-macos, build-android]
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Display structure
      run: ls -R artifacts

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/linux-build/*.tar.gz
          artifacts/windows-build/*.zip
          artifacts/macos-build/*.zip
          artifacts/android-apk/*.apk
        generate_release_notes: true
        name: "Flutter App ${{ github.ref_name }}"
        body: |
          ## Flutter 判別クイズアプリ
          
          ### ダウンロード
          - **Windows**: similarity_quiz-windows-x64.zip
          - **macOS**: similarity_quiz-macos.zip
          - **Linux**: similarity_quiz-linux-x64.tar.gz
          - **Android**: app-release.apk
          
          ### インストール方法
          - Windows: ZIPを解凍して `similarity_quiz.exe` を実行
          - macOS: ZIPを解凍して `similarity_quiz.app` を実行
          - Linux: `tar -xzvf` で解凍して `similarity_quiz` を実行
          - Android: APKをインストール
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
