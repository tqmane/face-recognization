name: Flutter Build & Release

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Generate app icons
      working-directory: flutter-app
      run: |
        python generate_icons.py

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'

    - name: Install Linux dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev

    - name: Flutter doctor
      run: flutter doctor -v

    - name: Create platform folders if needed
      working-directory: flutter-app
      run: |
        if [ ! -d "linux" ]; then
          flutter create --project-name similarity_quiz --org com.tqmane --platforms=linux .
        fi

    - name: Set Linux app icon
      working-directory: flutter-app
      run: |
        # デスクトップファイル用にアイコンをコピー
        if [ -f "assets/icon/app_icon.png" ] && [ -d "linux" ]; then
          cp assets/icon/app_icon.png linux/
          # my_application.ccでウィンドウアイコンを設定
          if [ -f "linux/my_application.cc" ]; then
            # アイコン読み込みコードを追加（gtk_window_set_icon_from_file使用）
            sed -i 's/gtk_window_set_title(window, "similarity_quiz");/gtk_window_set_title(window, "判別クイズ");\n  \n  \/\/ アプリアイコンを設定\n  GError *error = NULL;\n  gchar *icon_path = g_build_filename(g_get_current_dir(), "data", "flutter_assets", "assets", "icon", "app_icon.png", NULL);\n  if (g_file_test(icon_path, G_FILE_TEST_EXISTS)) {\n    gtk_window_set_icon_from_file(window, icon_path, \&error);\n    if (error != NULL) {\n      g_warning("Failed to set icon: %s", error->message);\n      g_error_free(error);\n    }\n  }\n  g_free(icon_path);/' linux/my_application.cc || true
          fi
        fi

    - name: Clean and get dependencies
      working-directory: flutter-app
      run: |
        flutter clean
        flutter pub get

    - name: Run tests
      working-directory: flutter-app
      run: flutter test || echo "No tests found"

    - name: Build Linux
      working-directory: flutter-app
      run: flutter build linux --release

    - name: Package Linux build
      run: |
        cd flutter-app/build/linux/x64/release/bundle
        tar -czvf ../../../../../similarity_quiz-linux-x64.tar.gz .

    - name: Upload Linux build
      uses: actions/upload-artifact@v4
      with:
        name: linux-build
        path: flutter-app/similarity_quiz-linux-x64.tar.gz

  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Generate app icons
      working-directory: flutter-app
      run: |
        python generate_icons.py

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'

    - name: Flutter doctor
      run: flutter doctor -v

    - name: Create platform folders if needed
      working-directory: flutter-app
      run: |
        if (!(Test-Path "windows")) {
          flutter create --project-name similarity_quiz --org com.tqmane --platforms=windows .
        }

    - name: Set Windows app icon
      working-directory: flutter-app
      shell: pwsh
      run: |
        # Windows用のアイコンを設定
        if ((Test-Path "assets/icon/app_icon.png") -and (Test-Path "windows/runner/resources")) {
          # PNGからICOに変換（magickがインストールされていれば）
          # windows/runner/resources/app_icon.ico として保存
          Copy-Item "assets/icon/app_icon.png" "windows/runner/resources/app_icon.png"
          # Runner.rcのアイコン参照を更新
          $rcFile = "windows/runner/Runner.rc"
          if (Test-Path $rcFile) {
            (Get-Content $rcFile) -replace 'IDI_APP_ICON\s+ICON\s+"resources\\app_icon.ico"', 'IDI_APP_ICON ICON "resources\app_icon.ico"' | Set-Content $rcFile
          }
        }

    - name: Clean and get dependencies
      working-directory: flutter-app
      run: |
        flutter clean
        flutter pub get

    - name: Build Windows
      working-directory: flutter-app
      run: flutter build windows --release

    - name: Package Windows build
      run: |
        Compress-Archive -Path flutter-app/build/windows/x64/runner/Release/* -DestinationPath flutter-app/similarity_quiz-windows-x64.zip

    - name: Upload Windows build
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: flutter-app/similarity_quiz-windows-x64.zip

  build-macos:
    runs-on: macos-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Generate app icons
      working-directory: flutter-app
      run: |
        python generate_icons.py

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'

    - name: Flutter doctor
      run: flutter doctor -v

    - name: Create platform folders if needed
      working-directory: flutter-app
      run: |
        if [ ! -d "macos" ]; then
          flutter create --project-name similarity_quiz --org com.tqmane --platforms=macos .
        fi

    - name: Set macOS app icon
      working-directory: flutter-app
      run: |
        # macOS用のアイコンを生成・設定
        if [ -f "assets/icon/app_icon.png" ] && [ -d "macos/Runner/Assets.xcassets" ]; then
          # App Icon用にアイコンを配置
          ICON_DIR="macos/Runner/Assets.xcassets/AppIcon.appiconset"
          mkdir -p "$ICON_DIR"
          # 各サイズにリサイズ
          for size in 16 32 64 128 256 512 1024; do
            sips -z $size $size assets/icon/app_icon.png --out "$ICON_DIR/app_icon_${size}.png" || true
          done
        fi

    - name: Clean and get dependencies
      working-directory: flutter-app
      run: |
        flutter clean
        flutter pub get

    - name: Build macOS
      working-directory: flutter-app
      run: flutter build macos --release

    - name: Package macOS build
      run: |
        cd flutter-app/build/macos/Build/Products/Release
        zip -r ../../../../../similarity_quiz-macos.zip "similarity_quiz.app"

    - name: Upload macOS build
      uses: actions/upload-artifact@v4
      with:
        name: macos-build
        path: flutter-app/similarity_quiz-macos.zip

  build-ios:
    runs-on: macos-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Generate app icons
      working-directory: flutter-app
      run: |
        python generate_icons.py

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'

    - name: Flutter doctor
      run: flutter doctor -v

    - name: Create platform folders if needed
      working-directory: flutter-app
      run: |
        if [ ! -d "ios" ]; then
          flutter create --project-name similarity_quiz --org com.tqmane --platforms=ios .
        fi

    - name: Set iOS app icon
      working-directory: flutter-app
      run: |
        # iOS用のアイコンを生成・設定
        if [ -f "assets/icon/app_icon.png" ] && [ -d "ios/Runner/Assets.xcassets" ]; then
          ICON_DIR="ios/Runner/Assets.xcassets/AppIcon.appiconset"
          mkdir -p "$ICON_DIR"
          # 各サイズにリサイズ（iOS用）
          for size in 20 29 40 58 60 76 80 87 120 152 167 180 1024; do
            sips -z $size $size assets/icon/app_icon.png --out "$ICON_DIR/Icon-App-${size}x${size}.png" || true
          done
        fi

    - name: Set iOS deployment target to 16.4
      working-directory: flutter-app/ios
      run: |
        # Podfileの最小バージョンを16.4に設定
        sed -i '' "s/platform :ios, '.*'/platform :ios, '16.4'/" Podfile
        # project.pbxprojのIPHONEOS_DEPLOYMENT_TARGETを更新
        sed -i '' 's/IPHONEOS_DEPLOYMENT_TARGET = [0-9.]*;/IPHONEOS_DEPLOYMENT_TARGET = 16.4;/g' Runner.xcodeproj/project.pbxproj

    - name: Clean and get dependencies
      working-directory: flutter-app
      run: |
        flutter clean
        flutter pub get

    - name: Install CocoaPods dependencies
      working-directory: flutter-app/ios
      run: pod install

    - name: Build iOS (no codesign)
      working-directory: flutter-app
      run: flutter build ios --release --no-codesign

    - name: Create IPA package
      run: |
        cd flutter-app/build/ios/iphoneos
        mkdir -p Payload
        cp -r Runner.app Payload/
        zip -r ../../../similarity_quiz-ios.ipa Payload

    - name: Upload iOS build
      uses: actions/upload-artifact@v4
      with:
        name: ios-build
        path: flutter-app/similarity_quiz-ios.ipa

  build-android:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Generate app icons
      working-directory: flutter-app
      run: |
        python generate_icons.py

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'

    - name: Flutter doctor
      run: flutter doctor -v

    - name: Create platform folders if needed
      working-directory: flutter-app
      run: |
        if [ ! -d "android" ]; then
          flutter create --project-name similarity_quiz --org com.tqmane --platforms=android .
        fi

    - name: Update Kotlin version for compatibility
      working-directory: flutter-app/android
      run: |
        # Update Kotlin version in settings.gradle
        if [ -f "settings.gradle" ]; then
          sed -i 's/id "org.jetbrains.kotlin.android" version "[^"]*"/id "org.jetbrains.kotlin.android" version "1.9.22"/' settings.gradle
        fi
        # Update Kotlin version in build.gradle if ext.kotlin_version exists
        if [ -f "build.gradle" ]; then
          sed -i 's/ext.kotlin_version = .*/ext.kotlin_version = "1.9.22"/' build.gradle
        fi

    - name: Setup signing
      env:
        KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      run: |
        if [ -n "$KEYSTORE_BASE64" ]; then
          echo "$KEYSTORE_BASE64" | base64 -d > flutter-app/android/app/release.keystore
          cat > flutter-app/android/key.properties << EOF
        storePassword=$KEYSTORE_PASSWORD
        keyPassword=$KEY_PASSWORD
        keyAlias=$KEY_ALIAS
        storeFile=release.keystore
        EOF
        fi

    - name: Configure signing in build.gradle
      working-directory: flutter-app/android/app
      run: |
        if [ -f "../key.properties" ]; then
          # build.gradleに署名設定を追加
          cat > signing_config.gradle << 'SIGNING'
        def keystoreProperties = new Properties()
        def keystorePropertiesFile = rootProject.file('key.properties')
        if (keystorePropertiesFile.exists()) {
            keystoreProperties.load(new FileInputStream(keystorePropertiesFile))
        }

        android {
            signingConfigs {
                release {
                    keyAlias keystoreProperties['keyAlias']
                    keyPassword keystoreProperties['keyPassword']
                    storeFile file(keystoreProperties['storeFile'])
                    storePassword keystoreProperties['storePassword']
                }
            }
            buildTypes {
                release {
                    signingConfig signingConfigs.release
                }
            }
        }
        SIGNING
          # build.gradleの最後に追加
          echo "" >> build.gradle
          echo "apply from: 'signing_config.gradle'" >> build.gradle
        fi

    - name: Get dependencies
      working-directory: flutter-app
      run: flutter pub get

    - name: Build APK
      working-directory: flutter-app
      run: flutter build apk --release

    - name: Rename signed APK
      run: |
        if [ -f "flutter-app/android/key.properties" ]; then
          mv flutter-app/build/app/outputs/flutter-apk/app-release.apk flutter-app/build/app/outputs/flutter-apk/similarity_quiz-signed.apk
        else
          mv flutter-app/build/app/outputs/flutter-apk/app-release.apk flutter-app/build/app/outputs/flutter-apk/similarity_quiz-unsigned.apk
        fi

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: flutter-app/build/app/outputs/flutter-apk/similarity_quiz-*.apk

  # リリースジョブ
  release:
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-macos, build-ios, build-android]
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Display structure
      run: ls -R artifacts

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/linux-build/*.tar.gz
          artifacts/windows-build/*.zip
          artifacts/macos-build/*.zip
          artifacts/ios-build/*.ipa
          artifacts/android-apk/*.apk
        generate_release_notes: true
        name: "Flutter App ${{ github.ref_name }}"
        body: |
          ## Flutter 判別クイズアプリ
          
          ### ダウンロード
          - **Windows**: similarity_quiz-windows-x64.zip
          - **macOS**: similarity_quiz-macos.zip
          - **Linux**: similarity_quiz-linux-x64.tar.gz
          - **iOS**: similarity_quiz-ios.ipa (要署名/AltStore等)
          - **Android**: app-release.apk
          
          ### インストール方法
          - Windows: ZIPを解凍して `similarity_quiz.exe` を実行
          - macOS: ZIPを解凍して `similarity_quiz.app` を実行
          - Linux: `tar -xzvf` で解凍して `similarity_quiz` を実行
          - iOS: AltStore/Sideloadly等でインストール
          - Android: APKをインストール
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
